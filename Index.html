<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriSnap AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-24">

    <header class="bg-white border-b sticky top-0 z-30 p-4">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-emerald-500 p-2 rounded-xl text-white">
                    <i data-lucide="utensils" class="w-5 h-5"></i>
                </div>
                <h1 class="font-extrabold text-xl tracking-tight">NutriSnap AI</h1>
            </div>
            <div id="user-badge" class="text-[10px] bg-slate-100 px-2 py-1 rounded-full text-slate-500 font-mono">Connecting...</div>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-6">
        <section class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100 flex justify-between items-center">
            <div>
                <p class="text-slate-400 text-[10px] font-bold uppercase mb-1">Total Calories</p>
                <p class="text-3xl font-black text-slate-800"><span id="total-kcal">0</span></p>
            </div>
            <div class="h-10 w-px bg-slate-100"></div>
            <div>
                <p class="text-slate-400 text-[10px] font-bold uppercase mb-1">Total Protein</p>
                <p class="text-3xl font-black text-slate-800"><span id="total-protein">0</span>g</p>
            </div>
        </section>

        <div id="meal-list" class="space-y-3">
             <div class="text-center py-12 text-slate-400">Fetching logs...</div>
        </div>
    </main>

    <!-- Footer Controls -->
    <div class="fixed bottom-8 left-0 right-0 flex justify-center px-6 z-40">
        <div class="bg-slate-900 rounded-full shadow-2xl p-2 flex gap-2">
            <button onclick="window.openModal()" class="flex items-center gap-2 bg-slate-800 text-white py-3 px-6 rounded-full transition-transform active:scale-95">
                <i data-lucide="plus" class="w-5 h-5"></i>
                <span class="font-bold">Manual</span>
            </button>
            <label class="flex items-center justify-center bg-emerald-500 text-white w-12 h-12 rounded-full cursor-pointer transition-transform active:scale-95">
                <i data-lucide="camera" class="w-6 h-6"></i>
                <input type="file" id="file-input" accept="image/*" class="hidden" onchange="window.handleImageAnalysis(this)">
            </label>
        </div>
    </div>

    <!-- Modal UI -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[2rem] p-8 shadow-2xl">
            <div id="form-view">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black">New Meal</h2>
                    <button onclick="window.closeModal()" class="text-slate-400"><i data-lucide="x"></i></button>
                </div>
                <div class="space-y-4">
                    <input type="text" id="meal-name" placeholder="What did you eat?" class="w-full bg-slate-50 p-4 rounded-xl outline-none border focus:border-emerald-500">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="meal-kcal" placeholder="Kcal" class="bg-slate-50 p-4 rounded-xl outline-none border focus:border-emerald-500">
                        <input type="number" id="meal-prot" placeholder="Prot (g)" class="bg-slate-50 p-4 rounded-xl outline-none border focus:border-emerald-500">
                    </div>
                    <button onclick="window.submitManual()" class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl transition-colors hover:bg-slate-800">Save Entry</button>
                </div>
            </div>
            <div id="loading-view" class="hidden py-10 text-center space-y-4">
                <i data-lucide="refresh-cw" class="w-12 h-12 text-emerald-500 mx-auto spinner"></i>
                <p class="font-bold">AI Analysis in Progress...</p>
                <p class="text-xs text-slate-400 italic">Bypassing regional locks via Proxy</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- REPLACE WITH YOUR CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAMWYs6rZ7kVDyKhsZQWCMgkGU_Zckfjxw",
            authDomain: "nutrisnap-e91f9.firebaseapp.com",
            projectId: "nutrisnap-e91f9",
            storageBucket: "nutrisnap-e91f9.firebasestorage.app",
            messagingSenderId: "524470882633",
            appId: "1:524470882633:web:0823f92ef9a6c62a774a98"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "nutrisnap-personal-v1";
        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-badge').innerText = `ID: ${user.uid.slice(0,6)}`;
                syncMeals();
            } else {
                signInAnonymously(auth);
            }
        });

        function syncMeals() {
            const path = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'meals');
            onSnapshot(path, (snap) => {
                const meals = snap.docs.map(d => ({id: d.id, ...d.data()}));
                render(meals);
            });
        }

        function render(meals) {
            const list = document.getElementById('meal-list');
            let tk = 0, tp = 0;
            list.innerHTML = meals.length ? meals.map(m => {
                tk += Number(m.calories); tp += Number(m.protein);
                return `
                <div class="bg-white p-4 rounded-xl flex justify-between items-center shadow-sm border mb-2">
                    <div><h3 class="font-bold text-sm text-slate-800">${m.name}</h3><p class="text-xs text-slate-400">${m.calories}kcal â€¢ ${m.protein}g protein</p></div>
                    <button onclick="window.deleteEntry('${m.id}')" class="text-slate-300 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>`;
            }).join('') : `<div class="text-center py-10 text-slate-400">Log is empty. Start by snapping a photo!</div>`;
            document.getElementById('total-kcal').innerText = tk;
            document.getElementById('total-protein').innerText = tp;
            lucide.createIcons();
        }

        window.handleImageAnalysis = async (input) => {
            const file = input.files[0];
            if (!file) return;
            window.openModal();
            document.getElementById('form-view').classList.add('hidden');
            document.getElementById('loading-view').classList.remove('hidden');

            const reader = new FileReader();
            reader.onloadend = async () => {
                const base64 = reader.result.split(',')[1];
                try {
                    // --- REPLACE WITH YOUR VERCEL URL ---
                    const PROXY_URL = "https://YOUR-PROJECT.vercel.app/api/analyze"; 
                    
                    const res = await fetch(PROXY_URL, {
                        method: 'POST',
                        body: JSON.stringify({ image: base64 })
                    });
                    
                    if (!res.ok) throw new Error("Proxy response failed");
                    
                    const data = await res.json();
                    await window.saveMeal(data.name, data.calories, data.protein);
                    window.closeModal();
                } catch (e) {
                    alert("Analysis failed. Please check your proxy settings.");
                    window.closeModal();
                }
            };
            reader.readAsDataURL(file);
        };

        window.saveMeal = async (n, k, p) => {
            if (!currentUser) return;
            await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'meals'), {
                name: n, calories: k, protein: p, timestamp: Timestamp.now()
            });
        };

        window.deleteEntry = async (id) => {
            if (!currentUser) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'meals', id));
        };

        window.openModal = () => document.getElementById('modal-overlay').classList.remove('hidden');
        window.closeModal = () => {
            document.getElementById('modal-overlay').classList.add('hidden');
            document.getElementById('loading-view').classList.add('hidden');
            document.getElementById('form-view').classList.remove('hidden');
            document.getElementById('file-input').value = '';
        };

        window.submitManual = () => {
            const n = document.getElementById('meal-name').value;
            const k = document.getElementById('meal-kcal').value;
            const p = document.getElementById('meal-prot').value;
            if(n) window.saveMeal(n, k||0, p||0);
            window.closeModal();
        };

        lucide.createIcons();
    </script>
</body>
</html>
